apiVersion: v1
kind: ConfigMap
metadata:
  name: t05-fluentd-config
  namespace: team05
data:
  fluent.conf: |-
    ################################################################
    # This source gets all logs from local docker host
    @include pods-fluent.conf
    #@include aggregate-to-index
    @include file-fluent.conf
    #@include elastic-fluent.conf
    #@include mongo-fluent.cont

  pods-fluent.conf: |-
    <source>
      @type forward
      bind 0.0.0.0
      port 24224
    </source>

    <filter **t05-fakemicroservice**>
      @type parser
      key_name log
      <parse>
        @type json
      </parse> 
    </filter>

 

  aggregate-to-index: |-
    <match **t05-fakemicroservice**>
      @type rewrite_tag_filter
      <rule>
        key $.event
        pattern ^(.+)$
        tag $1.${tag}
      </rule>
    </match>

  file-fluent.conf: |-
    <match **t05-fakemicroservice**>
      @type file
      path /tmp/fake-microservice.log
    </match>
    
    <match **>
      @type file
      path /tmp/file-test.log
    </match>


    
    
  mongo-fluent.cont: |-
    <match userCreated.fakemicroservice.**>
      @type mongo
      host t05-mongodb
      port 27017
      database t05
      collection users
      #for capped collection
      capped
      capped_size 1024m
      # authentication
      user username123
      password password123
      <buffer>
      # flush
        flush_interval 10s
      </buffer>
    </match>
   
  elastic-fluent.conf: |-
    <match songStarted.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name songStarted
    </match>

    <match songSkipped.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name songSkipped
    </match>

    <match songPaused.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name songPaused
    </match>

    <match songUnpaused.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name songUnpaused
    </match>

    <match search.t05-fakemicroservice-team05>
     @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name search
    </match>

    <match userCreated.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name users
    </match>

     <match adClicks.t05-fakemicroservice-team05>
      @type elasticsearch
      host "#{ENV['FLUENT_ELASTICSEARCH_HOST'] || 't05-elasticsearch'}"
      port "#{ENV['FLUENT_ELASTICSEARCH_PORT'] || '9200'}"
      index_name adClicks
    </match>

    <match fluent.**>
      @type null
    </match>
 